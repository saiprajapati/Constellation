<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Constellation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; color: #e0e0e0; overflow: hidden; }
        #sky { position: absolute; top: 0; left: 0; right: 0; bottom: 0; transition: background 2s linear, box-shadow 2s linear; z-index: -2; }
        .font-serif { font-family: 'Playfair Display', serif; }
        #sun, #moon { position: absolute; width: 80px; height: 80px; border-radius: 50%; transition: all 1s linear; z-index: -1; }
        #sun { background-color: #FFD700; box-shadow: 0 0 50px #FFD700; }
        #moon { background-color: #f5f3ce; box-shadow: 0 0 40px #f5f3ce; cursor: pointer; }
        #moon .crater { position: absolute; background-color: #e0dbb1; border-radius: 50%; }
        #moon .crater1 { width: 20px; height: 20px; top: 15px; left: 45px; }
        #moon .crater2 { width: 15px; height: 15px; top: 40px; left: 15px; }
        #moon .crater3 { width: 10px; height: 10px; top: 55px; left: 50px; }
        .star-wrapper { position: absolute; transition: opacity 2s ease, display 0s 2s; }
        .star { position: relative; width: 12px; height: 12px; background-color: #ffffff; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; animation: twinkle 4s infinite ease-in-out; box-shadow: 0 0 10px #ffffff, 0 0 20px #ffffff, 0 0 30px #a29bfe; }
        .star:hover { transform: scale(1.8); box-shadow: 0 0 15px #fff, 0 0 30px #fff, 0 0 45px #d63031; }
        .star-label { position: absolute; bottom: 150%; left: 50%; transform: translateX(-50%); background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; pointer-events: none; }
        .star:hover .star-label { opacity: 1; visibility: visible; }
        @keyframes twinkle { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.2); opacity: 1; } }
        #digital-clock { position: fixed; top: 20px; right: 20px; font-size: 1.5rem; color: white; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 10px; text-shadow: 0 0 5px black; z-index: 100; cursor: pointer; }
        .modal-overlay { z-index: 1000; }
        #moon-message { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); text-align: center; color: #f5f3ce; opacity: 0; transition: opacity 0.5s; width: 250px; pointer-events: none; }
        #moon:hover #moon-message { opacity: 1; }
        .cloud { position: absolute; background: #fff; border-radius: 50%; opacity: 0.6; animation: drift linear infinite; }
        .cloud:before, .cloud:after { content: ''; position: absolute; background: #fff; border-radius: 50%; }
        .cloud.c1 { width: 100px; height: 100px; animation-duration: 40s; } .cloud.c1:before { width: 60px; height: 60px; top: -30px; left: 20px; } .cloud.c1:after { width: 80px; height: 80px; top: -20px; right: 10px; }
        .cloud.c2 { width: 150px; height: 150px; animation-duration: 60s; } .cloud.c2:before { width: 90px; height: 90px; top: -50px; left: 30px; } .cloud.c2:after { width: 120px; height: 120px; top: -40px; right: 20px; }
        .rain-drop { position: absolute; bottom: 100%; width: 1px; height: 50px; background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.4)); animation: fall linear infinite; }
        @keyframes drift { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }
        @keyframes fall { from { transform: translateY(0vh); } to { transform: translateY(110vh); } }
    </style>
</head>
<body class="w-screen h-screen p-4">

    <div id="sky"></div>
    <div id="cloud-container"></div><div id="rain-container"></div>
    <div id="digital-clock">00:00:00</div>

    <div id="sun" class="hidden"></div>
    <div id="moon" class="hidden"><div class="crater crater1"></div><div class="crater crater2"></div><div class="crater crater3"></div><div id="moon-message"><h3 class="font-serif text-lg">My Moon</h3><p class="text-sm">Why are you searching the sky? You're the moon of my life.</p></div></div>
    
    <header class="absolute top-0 left-0 right-0 pt-8 text-center z-10"><h1 class="font-serif text-4xl md:text-6xl text-white mb-2" style="text-shadow: 0 0 10px rgba(0,0,0,0.5);">Our Constellation</h1><p class="text-lg text-gray-300 max-w-2xl mx-auto">Every memory is a star in our personal sky.</p></header>

    <main id="constellation" class="relative w-full h-full"></main>

    <!-- Memory Modal -->
    <div id="modal-overlay" class="modal-overlay fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-80 flex items-center justify-center opacity-0 invisible transition-all duration-300"><div class="modal-content bg-[#1e1a3b] text-gray-200 p-8 rounded-2xl max-w-lg w-11/2 relative transform translate-y-5 transition-all duration-300 border border-purple-400 shadow-lg shadow-purple-400/20"><h3 id="modal-title" class="font-serif text-3xl text-white mb-4"></h3><img id="modal-image" src="" class="hidden rounded-lg mb-4 max-h-60 w-auto mx-auto"><div id="modal-body" class="whitespace-pre-wrap max-h-[40vh] overflow-y-auto text-gray-300 pr-4"></div><audio id="modal-audio" src=""></audio><button id="modal-close" class="absolute top-4 right-4 text-gray-400 hover:text-white transition"><svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="modal-overlay fixed top-0 left-0 right-0 bottom-0 bg-black bg-opacity-80 flex items-center justify-center opacity-0 invisible transition-all duration-300"><div class="modal-content bg-[#1e1a3b] text-gray-200 p-8 rounded-2xl max-w-sm w-11/12 relative transform translate-y-5 transition-all duration-300 border border-purple-400 shadow-lg shadow-purple-400/20"><h3 class="font-serif text-2xl text-white mb-4 text-center">Enter Passcode</h3><input type="password" id="password-input" class="w-full bg-gray-700 text-white rounded-lg p-3 text-center text-lg focus:outline-none focus:ring-2 focus:ring-purple-500"><p id="password-error" class="text-red-400 text-center mt-2 h-4"></p><button id="password-submit" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 mt-4 rounded-lg transition">Unlock</button></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sky = document.getElementById('sky');
            const sun = document.getElementById('sun');
            const moon = document.getElementById('moon');
            const constellation = document.getElementById('constellation');
            const digitalClock = document.getElementById('digital-clock');
            const cloudContainer = document.getElementById('cloud-container');
            const rainContainer = document.getElementById('rain-container');
            const passwordModal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordSubmit = document.getElementById('password-submit');
            const passwordError = document.getElementById('password-error');
            const CORRECT_PASSWORD = 'iloveyou'; 
            
            let skyState = {};

            function getInitialState() {
                const stateStr = localStorage.getItem('skyControlState');
                if (stateStr) {
                    try {
                        const state = JSON.parse(stateStr);
                        // Ensure critical properties exist to prevent errors
                        if (state && Array.isArray(state.stars)) {
                            return state;
                        }
                    } catch (e) {
                        console.error("Could not parse saved state, resetting.", e);
                        // If parsing fails, fall through to return the default state
                    }
                }
                
                // Default state if nothing is in localStorage or if parsing failed
                return {
                    weather: 'clear', sunMode: 'normal', moonMode: 'normal', starsMode: 'visible',
                    stars: [
                        {id: Date.now(), label: "The Day We Met", title: "A New Universe", body: "Edit this memory in the controller!", imageURL: "", songURL: "", top: `${Math.random()*80+10}%`, left: `${Math.random()*80+10}%` },
                        {id: Date.now()+1, label: "Our First Date", title: "Our First Adventure", body: "I was so nervous...", imageURL: "", songURL: "", top: `${Math.random()*80+10}%`, left: `${Math.random()*80+10}%` }
                    ]
                };
            }

            function renderStars() {
                if (!skyState || !Array.isArray(skyState.stars)) return;

                const starWrappers = document.querySelectorAll('.star-wrapper');
                const isDay = sun.classList.contains('hidden') === false;

                const starIdsOnPage = new Set([...starWrappers].map(sw => sw.dataset.id));
                const starIdsInState = new Set(skyState.stars.map(s => String(s.id)));

                // Remove stars that are no longer in the state
                starWrappers.forEach(sw => {
                    if (!starIdsInState.has(sw.dataset.id)) {
                        sw.remove();
                    }
                });

                // Add or update stars
                skyState.stars.forEach(starData => {
                    let wrapper = constellation.querySelector(`.star-wrapper[data-id="${starData.id}"]`);
                    if (!wrapper) {
                        wrapper = document.createElement('div');
                        wrapper.className = 'star-wrapper';
                        wrapper.dataset.id = starData.id;
                        wrapper.innerHTML = `<div class="star"><span class="star-label"></span></div>`;
                        constellation.appendChild(wrapper);
                    }
                    wrapper.style.top = starData.top;
                    wrapper.style.left = starData.left;
                    wrapper.style.opacity = isDay ? '0' : '1';
                    wrapper.style.display = skyState.starsMode === 'hidden' ? 'none' : 'block';
                    wrapper.querySelector('.star-label').textContent = starData.label;
                });
            }


            digitalClock.addEventListener('click', () => { passwordModal.classList.remove('invisible', 'opacity-0'); passwordModal.querySelector('.modal-content').classList.remove('translate-y-5'); passwordInput.focus(); });
            passwordSubmit.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') checkPassword(); });
            function checkPassword() { if (passwordInput.value === CORRECT_PASSWORD) { window.open('controller.html', '_blank'); closePasswordModal(); } else { passwordError.textContent = 'Incorrect password.'; passwordInput.value = ''; } }
            function closePasswordModal() { passwordModal.classList.add('invisible', 'opacity-0'); passwordModal.querySelector('.modal-content').classList.add('translate-y-5'); passwordInput.value = ''; passwordError.textContent = ''; }
            passwordModal.addEventListener('click', (e) => { if (e.target === passwordModal) closePasswordModal(); });

            const skyColors = { night: 'linear-gradient(to bottom, #0c0a1a, #1e1a3b, #2a244d)', sunrise: 'linear-gradient(to bottom, #74567b, #e08b6f, #f9d4a5)', day: 'linear-gradient(to bottom, #87CEEB, #B0E0E6, #ADD8E6)', sunset: 'linear-gradient(to bottom, #ff7e5f, #feb47b, #f5d0a9)'};
            function updateSky(hours, minutes) { const time = hours + minutes / 60; if (time >= 5 && time < 7) sky.style.background = skyColors.sunrise; else if (time >= 7 && time < 17) sky.style.background = skyColors.day; else if (time >= 17 && time < 19) sky.style.background = skyColors.sunset; else sky.style.background = skyColors.night; }
            
            function updateCelestialBodies(hours, minutes) {
                const now = hours + minutes / 60;
                const isDay = now >= 6 && now < 18.5;

                sun.classList.toggle('hidden', !isDay);
                moon.classList.toggle('hidden', isDay);
                
                if (isDay) {
                    const percentOfDay = (now - 6) / (18.5 - 6);
                    const x = percentOfDay * 100;
                    const y = Math.sin(percentOfDay * Math.PI) * 50; 
                    sun.style.left = `${x}vw`;
                    sun.style.top = `${75 - y}vh`;
                } else {
                    const nightHour = now < 6 ? now + 24 : now;
                    const percentOfNight = (nightHour - 18.5) / (24 + 6 - 18.5);
                    const x = percentOfNight * 100;
                    const y = Math.sin(percentOfNight * Math.PI) * 50;
                    moon.style.left = `${x}vw`;
                    moon.style.top = `${70 - y}vh`;
                }
                renderStars(); // re-check opacity
            }

            function applySkyState() {
                if (!skyState) return;
                cloudContainer.innerHTML = ''; rainContainer.innerHTML = '';
                if (skyState.weather === 'cloudy' || skyState.weather === 'rainy') { cloudContainer.innerHTML = `<div class="cloud c1" style="top: 10%; animation-delay: -5s;"></div><div class="cloud c2" style="top: 25%; animation-delay: -20s;"></div>`; }
                if (skyState.weather === 'rainy') { let rainHTML = ''; for (let i = 0; i < 50; i++) { rainHTML += `<div class="rain-drop" style="left: ${Math.random()*100}vw; animation-duration: ${Math.random()*0.5+0.3}s; animation-delay: ${Math.random()*2}s;"></div>`; } rainContainer.innerHTML = rainHTML; }
                
                sun.style.boxShadow = skyState.sunMode === 'bright' ? '0 0 100px #FFD700, 0 0 150px #FFD700' : '0 0 50px #FFD700';
                moon.style.boxShadow = skyState.moonMode === 'bright' ? '0 0 80px #f5f3ce, 0 0 120px #f5f3ce' : '0 0 40px #f5f3ce';
                moon.style.display = skyState.moonMode === 'hidden' ? 'none' : '';
                renderStars();
            }

            function gameLoop() {
                const now = new Date();
                updateSky(now.getHours(), now.getMinutes());
                updateCelestialBodies(now.getHours(), now.getMinutes());
                digitalClock.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            }

            window.addEventListener('storage', (event) => {
                if (event.key === 'skyControlState') {
                    try {
                        const newState = JSON.parse(event.newValue);
                        // Validate the new state to prevent errors
                        if (newState && Array.isArray(newState.stars)) {
                            skyState = newState;
                            applySkyState();
                        } else {
                            console.warn("Received invalid state from storage. Ignoring update.");
                        }
                    } catch (e) {
                        console.error("Failed to parse state update from storage.", e);
                    }
                }
            });

            const modalOverlay = document.getElementById('modal-overlay'); const modalTitle = document.getElementById('modal-title'); const modalBody = document.getElementById('modal-body'); const modalImage = document.getElementById('modal-image'); const modalAudio = document.getElementById('modal-audio');
            const closeModal = () => { modalOverlay.classList.add('invisible', 'opacity-0'); modalOverlay.querySelector('.modal-content').classList.add('translate-y-5'); modalAudio.pause(); modalAudio.currentTime = 0; };
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay || e.target.closest('#modal-close')) closeModal(); });
            
            constellation.addEventListener('click', (e) => { 
                const starWrapper = e.target.closest('.star-wrapper'); 
                if(starWrapper) { 
                    const starId = starWrapper.dataset.id;
                    const starData = skyState.stars.find(s => String(s.id) === starId);
                    if (!starData) return;

                    modalTitle.textContent = starData.title;
                    modalBody.textContent = starData.body;
                    
                    modalImage.classList.toggle('hidden', !starData.imageURL);
                    modalImage.src = starData.imageURL || '';
                    
                    if (starData.songURL) {
                        modalAudio.src = starData.songURL;
                        modalAudio.play().catch(err => console.error("Audio play failed:", err));
                    } else {
                        modalAudio.src = '';
                    }

                    modalOverlay.classList.remove('invisible', 'opacity-0'); 
                    modalOverlay.querySelector('.modal-content').classList.remove('translate-y-5'); 
                } 
            });

            // Initial Load
            skyState = getInitialState();
            applySkyState();
            setInterval(gameLoop, 1000); 
            gameLoop();
        });
    </script>
</body>
</html>

